<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.wpwk.mappers.ContentsMapper">

    <!-- 컨텐츠 삽입 -->
    <insert id = "create" useGeneratedKeys="true" keyProperty="id" parameterType="com.ssafy.wpwk.model.Contents">
        INSERT INTO contents (title, spend_time, ability,
                              created_by, updated_by,user_id)
        VALUES(#{title}, #{spendTime}, #{ability}
               #{createdBy},#{updatedBy}, #{user.id})
    </insert>

    <!--컨텐츠 전체 조회 -->
    <select id="findAllContents" resultType="com.ssafy.wpwk.model.Contents">
        SELECT c.id,
               c.title,
               c.spend_time,
               c.likes,
               c.views,
               c.created_at,
               c.created_by,
               u.id as user_id,
               u.nickname
        FROM contents c, user u
        WHERE c.user_id = u.id
    </select>

    <!-- 컨텐츠 검색 이용한 조회 -->
    <select id="findContentsById" resultType="com.ssafy.wpwk.model.Contents">
        SELECT c.id,
               c.title,
               c.spend_time,
               c.likes,
               c.views,
               c.created_at,
               c.created_by,
               u.id as user_id,
               u.nickname
        FROM contents c, user u
        WHERE c.user_id = u.id
        AND c.id = #{id}
    </select>

    <!-- 컨텐츠 검색 이용한 조회 -->
    <select id="findContentsByTagName" resultType="com.ssafy.wpwk.model.Contents">
        SELECT DISTINCT c.id, c.user_id, c.title,
               c.spend_time, c.likes, c.views,
               c.created_at, c.updated_at, u.nickname
        FROM contents c
        JOIN contents_tag ct ON c.id = ct.contents_id
        JOIN tags t ON ct.tags_id = t.id
        JOIN user u ON c.user_id = u.id
        WHERE t.name LIKE CONCAT('%', #{tag}, '%')
    </select>

    <!-- 컨텐츠 검색 이용한 조회 (추가 수정 필요) -->
    <select id="findContentsByKeyword" resultType="com.ssafy.wpwk.model.Contents" parameterType="hashmap">
        SELECT c.id,
        c.title,
        c.spend_time,
        c.likes,
        c.views,
        c.created_at,
        c.created_by,
        u.id as user_id,
        u.nickname
        FROM contents
        <choose>
            <when test="option == 'tagName'">
                WHERE nickname = #{keyword}
            </when>
            <when test="option == 'nickname'">
                WHERE nickname = #{keyword}
            </when>
            <when test="option == 'title'">
                WHERE title = #{keyword}
            </when>
        </choose>
        ORDER BY id DESC;
    </select>

    <!--데이터 수정 -->
    <update id="update" parameterType="com.ssafy.wpwk.model.Contents">
        UPDATE contents SET
                           title = #{title},
                           spend_time = #{spendTime},
                           ability = #{ability},
                           updated_at = #{updatedAt},
                           updated_by = #{updatedBy}
        WHERE id = #{id}
    </update>

    <!-- 데이터 삭제 -->
    <delete id="delete">
        DELETE FROM contents
        WHERE id = #{id}
    </delete>
</mapper>