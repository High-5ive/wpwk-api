<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.wpwk.mappers.NotificationMapper">

    <!--공지사항 전체 조회 -->
    <select id="findAll" resultType="com.ssafy.wpwk.model.Notification">
        SELECT id, to_user_id, from_user_id, message_type,
               message, created_at, created_by, is_read, read_at
        FROM notification
    </select>

    <!-- 사용자별 공지사항 전체 조회 -->
    <select id="findAllByUserId" resultType="com.ssafy.wpwk.model.Notification">
        SELECT id, to_user_id, from_user_id, message_type,
               message, created_at, is_read, read_at
        FROM notification
        WHERE id = #{user.userId}
    </select>

    <!-- 사용자별 확인하지 않은 공지사항 전체 조회 -->
    <select id="findAllByUserIdAndNotRead" resultType="com.ssafy.wpwk.model.Notification">
        SELECT id, to_user_id, from_user_id, message_type,
               message, created_at
        FROM notification
        WHERE id = #{user.id}
        AND is_read = 0
    </select>

    <!-- 공지사항 특정 수신자에게 작성 -->
    <insert id = "createNotification" useGeneratedKeys="true" keyProperty="id"
            parameterType="com.ssafy.wpwk.model.Notification">
        INSERT INTO notification (to_user_id, from_user_id, message_type,
                              message, created_by)
        VALUES(#{toUser.id}, #{fromUser.id}, #{messageType},
               #{message}, #{createdAt}, #{createdBy})
    </insert>

    <!-- 공지사항 브로드 캐스팅 -->
    <insert id="broadCast" parameterType="map">
        INSERT INTO notification (to_user_id, from_user_id, message_type,
                                message, created_by)
        VALUES
        <foreach collection="userList" item="user" separator=" , ">
            (#{user.id}, #{notification.fromUser.id}, #{notification.message_type},
            #{notification.message}, #{notification.createdBy})
        </foreach>
    </insert>

    <!--데이터 수정 -->
    <update id="confirm" parameterType="com.ssafy.wpwk.model.Notification">
        UPDATE notification
        SET is_read = 1,
            read_at = NOW()
        WHERE to_user_id = #{userId}
        AND is_read = 0
    </update>

    <!-- 공지사항 삭제 -->
    <delete id="delete">
        DELETE FROM notification
        WHERE id = #{id}
    </delete>
</mapper>